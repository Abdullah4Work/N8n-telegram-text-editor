<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ØªØµØ­ÙŠØ­ Ø§Ù„Ù†Øµ - Ù…ÙˆÙ‚Ø¹ Ø±Ù‚ÙŠØªÙŠ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-color: #4A90E2;
            --primary-light: #5BA3F5;
            --primary-lighter: #E8F4FD;
            --text-primary: #2C3E50;
            --text-secondary: #7F8C8D;
            --border-color: #E1E8ED;
            --background: #F7F9FC;
            --danger: #E74C3C;
            --success: #27AE60;
            --warning: #F39C12;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
            color: white;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15);
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .header.hidden-keyboard {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }

        .header h1 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header .subtitle {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Audio Player - Ø¹Ø§Ø¯ÙŠ */
        .audio-player {
            background: white;
            margin: 12px 16px;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .audio-player.hidden-keyboard {
            transform: translateY(-120%);
            opacity: 0;
            pointer-events: none;
            margin: 0;
            padding: 0;
            max-height: 0;
        }

        /* Floating Audio Controls - Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ */
        .floating-audio-controls {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 8px 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            gap: 8px;
            align-items: center;
            border: 1px solid rgba(74, 144, 226, 0.2);
        }

        .floating-audio-controls.visible {
            display: flex;
            animation: slideInFromTop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .floating-play-btn {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        .floating-play-btn:active {
            transform: scale(0.9);
        }

        .floating-speed-control {
            display: flex;
            gap: 4px;
        }

        .floating-speed-btn {
            padding: 4px 7px;
            background: var(--primary-lighter);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-weight: 500;
            min-width: 32px;
            text-align: center;
        }

        .floating-speed-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 600;
        }

        .floating-time {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 600;
            direction: ltr;
        }

        /* Audio Player Ø¹Ø§Ø¯ÙŠ - Ø§Ù„ØªÙØ§ØµÙŠÙ„ */
        .audio-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .audio-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .audio-info {
            flex: 1;
            min-width: 0;
        }

        .audio-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .audio-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .play-btn {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .play-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--primary-lighter);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            direction: ltr;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4A90E2 0%, #5BA3F5 100%);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-secondary);
            direction: ltr;
        }

        .speed-section {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .speed-label {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .speed-controls {
            display: flex;
            gap: 4px;
            direction: ltr;
            flex-wrap: wrap;
        }

        .speed-btn {
            padding: 4px 8px;
            background: var(--primary-lighter);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-weight: 500;
            min-width: 42px;
            text-align: center;
        }

        .speed-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 600;
        }

        /* Content Area */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0 16px 12px;
            min-height: 0;
            transition: padding 0.3s ease;
        }

        .content.keyboard-mode {
            padding: 8px 12px 8px;
        }

        .info-card {
            background: linear-gradient(135deg, #E8F4FD 0%, #D6EBFF 100%);
            color: var(--primary-color);
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            line-height: 1.5;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(74, 144, 226, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .info-card.hidden-keyboard {
            transform: translateY(-60px);
            opacity: 0;
            margin: 0;
            padding: 0;
            max-height: 0;
            pointer-events: none;
        }

        /* Grammar Check Button */
        .grammar-check-btn {
            background: linear-gradient(135deg, var(--success) 0%, #229954 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 10px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
        }

        .grammar-check-btn:active {
            transform: scale(0.98);
        }

        .grammar-check-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .grammar-check-btn.checking {
            background: linear-gradient(135deg, var(--warning) 0%, #E67E22 100%);
        }

        .text-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-btn.copy {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .action-btn.paste {
            border-color: var(--success);
            color: var(--success);
        }

        .action-btn.clear {
            border-color: var(--danger);
            color: var(--danger);
        }

        .textarea-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
            min-height: 200px;
            position: relative;
        }

        textarea {
            flex: 1;
            width: 100%;
            padding: 14px;
            border: none;
            font-size: 15px;
            line-height: 1.7;
            resize: none;
            font-family: inherit;
            outline: none;
            color: var(--text-primary);
        }

        textarea::placeholder {
            color: #BDC3C7;
        }

        /* Grammar Suggestions */
        .grammar-suggestions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
            backdrop-filter: blur(5px);
            border-top: 1px solid var(--border-color);
            padding: 8px 12px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .grammar-suggestions.visible {
            display: block;
        }

        .suggestion-item {
            background: #FFF9E6;
            border: 1px solid #FFE4A3;
            border-radius: 8px;
            padding: 8px 10px;
            margin-bottom: 6px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .suggestion-text {
            flex: 1;
            color: var(--text-primary);
        }

        .suggestion-replace {
            background: var(--success);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Footer */
        .footer {
            padding: 10px 16px;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .footer.hidden-keyboard {
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
        }

        .stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 14px;
        }

        /* Loading & Error */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 1000;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--primary-lighter);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .error {
            background: #FEE;
            color: #C00;
            padding: 14px;
            border-radius: 10px;
            margin: 16px;
            text-align: center;
            font-size: 13px;
            border: 1px solid #FCC;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 360px) {
            .audio-name {
                font-size: 12px;
            }
            .stats {
                gap: 12px;
            }
            textarea {
                font-size: 14px;
                padding: 12px;
            }
            .action-btn {
                font-size: 11px;
                padding: 6px 8px;
            }
        }

        /* Desktop - Ù„Ø§ ØªØ®ÙÙŠ Ø´ÙŠ */
        @media (min-width: 769px) {
            .header.hidden-keyboard,
            .footer.hidden-keyboard,
            .audio-player.hidden-keyboard,
            .info-card.hidden-keyboard {
                transform: none !important;
                opacity: 1 !important;
                pointer-events: auto !important;
                margin: initial !important;
                padding: initial !important;
                max-height: none !important;
            }
            
            .floating-audio-controls.visible {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <!-- Floating Audio Controls (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯) -->
    <div class="floating-audio-controls" id="floatingAudioControls">
        <button class="floating-play-btn" id="floatingPlayBtn" title="ØªØ´ØºÙŠÙ„">â–¶ï¸</button>
        <div class="floating-time" id="floatingTime">0:00</div>
        <div class="floating-speed-control">
            <button class="floating-speed-btn" data-speed="0.75">0.75x</button>
            <button class="floating-speed-btn active" data-speed="1">1x</button>
            <button class="floating-speed-btn" data-speed="1.5">1.5x</button>
        </div>
    </div>

    <div id="app" style="display: none; height: 100%; display: flex; flex-direction: column;">
        <div class="header" id="header">
            <h1>
                <span>âœï¸</span>
                <span>ØªØµØ­ÙŠØ­ Ø§Ù„Ù†Øµ</span>
            </h1>
            <div class="subtitle">
                <span class="status-dot"></span>
                <span id="requestId">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            </div>
        </div>

        <div class="audio-player fade-in" id="audioPlayer">
            <div class="audio-header">
                <div class="audio-icon">ğŸµ</div>
                <div class="audio-info">
                    <div class="audio-name" id="audioName">Ù…Ù„Ù ØµÙˆØªÙŠ</div>
                    <div class="audio-meta" id="audioMeta">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
            
            <audio id="audioElement" preload="metadata" style="display: none;"></audio>
            
            <div class="audio-controls">
                <button class="play-btn" id="playBtn" title="ØªØ´ØºÙŠÙ„">â–¶ï¸</button>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-time">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                </div>
            </div>

            <div class="speed-section">
                <div class="speed-label">âš¡ Ø§Ù„Ø³Ø±Ø¹Ø©:</div>
                <div class="speed-controls" id="speedControls">
                    <button class="speed-btn" data-speed="0.5">0.5x</button>
                    <button class="speed-btn" data-speed="0.75">0.75x</button>
                    <button class="speed-btn active" data-speed="1">1x</button>
                    <button class="speed-btn" data-speed="1.25">1.25x</button>
                    <button class="speed-btn" data-speed="1.5">1.5x</button>
                    <button class="speed-btn" data-speed="2">2x</button>
                </div>
            </div>
        </div>

        <div class="content fade-in" id="content">
            <div class="info-card" id="infoCard">
                <span style="font-size: 18px;">ğŸ’¡</span>
                <span>Ø§Ø³ØªÙ…Ø¹ Ù„Ù„ØµÙˆØª ÙˆØµØ­Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù†Øµ</span>
            </div>

            <button class="grammar-check-btn" id="grammarCheckBtn">
                <span>âœ¨</span>
                <span>ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©</span>
            </button>

            <div class="text-actions">
                <button class="action-btn copy" id="copyBtn">
                    <span>ğŸ“‹</span>
                    <span>Ù†Ø³Ø®</span>
                </button>
                <button class="action-btn paste" id="pasteBtn">
                    <span>ğŸ“Œ</span>
                    <span>Ù„ØµÙ‚</span>
                </button>
                <button class="action-btn clear" id="clearBtn">
                    <span>ğŸ—‘ï¸</span>
                    <span>Ø­Ø°Ù</span>
                </button>
            </div>

            <div class="textarea-container">
                <textarea 
                    id="textArea" 
                    placeholder="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ..."
                    spellcheck="true"
                    autocomplete="off"
                    autocorrect="on"
                ></textarea>
                <div class="grammar-suggestions" id="grammarSuggestions"></div>
            </div>
        </div>

        <div class="footer" id="footer">
            <div class="stats">
                <div class="stat">
                    <span>ğŸ“Š</span>
                    <span class="stat-value" id="charCount">0</span>
                    <span>Ø­Ø±Ù</span>
                </div>
                <div class="stat">
                    <span>ğŸ“</span>
                    <span class="stat-value" id="wordCount">0</span>
                    <span>ÙƒÙ„Ù…Ø©</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        tg.setHeaderColor('secondary_bg_color');

        // Elements
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const appEl = document.getElementById('app');
        const textarea = document.getElementById('textArea');
        const charCount = document.getElementById('charCount');
        const wordCount = document.getElementById('wordCount');
        const requestIdEl = document.getElementById('requestId');

        // Layout elements
        const header = document.getElementById('header');
        const footer = document.getElementById('footer');
        const audioPlayer = document.getElementById('audioPlayer');
        const infoCard = document.getElementById('infoCard');
        const content = document.getElementById('content');
        const floatingAudioControls = document.getElementById('floatingAudioControls');

        // Audio elements
        const audioElement = document.getElementById('audioElement');
        const audioName = document.getElementById('audioName');
        const audioMeta = document.getElementById('audioMeta');
        const playBtn = document.getElementById('playBtn');
        const floatingPlayBtn = document.getElementById('floatingPlayBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const floatingTime = document.getElementById('floatingTime');

        // Action buttons
        const copyBtn = document.getElementById('copyBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const clearBtn = document.getElementById('clearBtn');
        const grammarCheckBtn = document.getElementById('grammarCheckBtn');
        const grammarSuggestions = document.getElementById('grammarSuggestions');

        // URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const binId = urlParams.get('bin');

        let isPlaying = false;
        let audioLoaded = false;
        let originalBinId = binId;
        let isKeyboardOpen = false;
        let currentGrammarErrors = [];

        // ğŸ¯ Keyboard Detection
        function detectKeyboard() {
            const isDesktop = window.innerWidth >= 769;
            if (isDesktop) return; // Ù„Ø§ ØªØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±

            let lastHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            
            function checkKeyboard() {
                const currentHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
                const heightDiff = lastHeight - currentHeight;
                
                if (heightDiff > 150 && !isKeyboardOpen) {
                    // Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ ÙØªØ­
                    isKeyboardOpen = true;
                    header.classList.add('hidden-keyboard');
                    footer.classList.add('hidden-keyboard');
                    audioPlayer.classList.add('hidden-keyboard');
                    infoCard.classList.add('hidden-keyboard');
                    content.classList.add('keyboard-mode');
                    floatingAudioControls.classList.add('visible');
                    tg.MainButton.hide();
                } else if (heightDiff < -150 && isKeyboardOpen) {
                    // Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§ØªÙ‚ÙÙ„
                    isKeyboardOpen = false;
                    header.classList.remove('hidden-keyboard');
                    footer.classList.remove('hidden-keyboard');
                    audioPlayer.classList.remove('hidden-keyboard');
                    infoCard.classList.remove('hidden-keyboard');
                    content.classList.remove('keyboard-mode');
                    floatingAudioControls.classList.remove('visible');
                    tg.MainButton.show();
                }
                
                lastHeight = currentHeight;
            }

            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', checkKeyboard);
            } else {
                window.addEventListener('resize', checkKeyboard);
            }

            // Detect focus
            textarea.addEventListener('focus', () => {
                setTimeout(checkKeyboard, 300);
            });

            textarea.addEventListener('blur', () => {
                setTimeout(checkKeyboard, 300);
            });
        }

        function showError(message) {
            errorEl.textContent = `âŒ ${message}`;
            errorEl.style.display = 'block';
            loadingEl.classList.add('hidden');
        }

        function updateCounters() {
            const text = textarea.value;
            const chars = text.length;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            
            charCount.textContent = chars.toLocaleString('ar');
            wordCount.textContent = words.toLocaleString('ar');
            
            tg.MainButton.setText(`Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ (${chars} Ø­Ø±Ù)`);
        }

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // âœ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(textarea.value);
                copyBtn.innerHTML = '<span>âœ…</span><span>ØªÙ… Ø§Ù„Ù†Ø³Ø®</span>';
                tg.HapticFeedback.notificationOccurred('success');
                
                setTimeout(() => {
                    copyBtn.innerHTML = '<span>ğŸ“‹</span><span>Ù†Ø³Ø®</span>';
                }, 2000);
            } catch (err) {
                textarea.select();
                document.execCommand('copy');
                copyBtn.innerHTML = '<span>âœ…</span><span>ØªÙ… Ø§Ù„Ù†Ø³Ø®</span>';
                tg.HapticFeedback.notificationOccurred('success');
                
                setTimeout(() => {
                    copyBtn.innerHTML = '<span>ğŸ“‹</span><span>Ù†Ø³Ø®</span>';
                }, 2000);
            }
        });

        // âœ… Ù„ØµÙ‚ Ø§Ù„Ù†Øµ
        pasteBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    const cursorPos = textarea.selectionStart;
                    const before = textarea.value.substring(0, cursorPos);
                    const after = textarea.value.substring(textarea.selectionEnd);
                    textarea.value = before + text + after;
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + text.length;
                    updateCounters();
                    tg.HapticFeedback.impactOccurred('medium');
                }
            } catch (err) {
                tg.showAlert('âš ï¸ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ù„ØµÙ‚. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ù„ØµÙ‚ ÙŠØ¯ÙˆÙŠØ§Ù‹');
            }
        });

        // âœ… Ø­Ø°Ù Ø§Ù„Ù†Øµ
        clearBtn.addEventListener('click', () => {
            if (textarea.value.trim()) {
                tg.showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù†Øµ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ', (confirmed) => {
                    if (confirmed) {
                        textarea.value = '';
                        updateCounters();
                        tg.HapticFeedback.impactOccurred('heavy');
                    }
                });
            }
        });

        // âœ¨ Grammar Check - Ø§Ø³ØªØ®Ø¯Ø§Ù… LanguageTool API Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ
        grammarCheckBtn.addEventListener('click', async () => {
            const text = textarea.value.trim();
            
            if (!text) {
                tg.showAlert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ù„Ù„ØªØµØ­ÙŠØ­');
                return;
            }

            if (text.length > 10000) {
                tg.showAlert('âš ï¸ Ø§Ù„Ù†Øµ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† 10,000 Ø­Ø±Ù)');
                return;
            }

            grammarCheckBtn.disabled = true;
            grammarCheckBtn.classList.add('checking');
            grammarCheckBtn.innerHTML = '<span>â³</span><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>';

            try {
                const response = await fetch('https://api.languagetool.org/v2/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        text: text,
                        language: 'ar',
                        enabledOnly: 'false'
                    })
                });

                if (!response.ok) {
                    throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„ØªØµØ­ÙŠØ­');
                }

                const data = await response.json();
                currentGrammarErrors = data.matches || [];

                if (currentGrammarErrors.length === 0) {
                    tg.showAlert('âœ… Ù„Ù… Ù†Ø¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©! Ø§Ù„Ù†Øµ Ù…Ù…ØªØ§Ø²');
                    grammarSuggestions.classList.remove('visible');
                } else {
                    displayGrammarSuggestions(currentGrammarErrors);
                    tg.HapticFeedback.notificationOccurred('success');
                }

            } catch (error) {
                console.error('Grammar check error:', error);
                tg.showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ­ÙŠØ­. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
            } finally {
                grammarCheckBtn.disabled = false;
                grammarCheckBtn.classList.remove('checking');
                grammarCheckBtn.innerHTML = '<span>âœ¨</span><span>ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©</span>';
            }
        });

        function displayGrammarSuggestions(errors) {
            grammarSuggestions.innerHTML = '';
            
            errors.slice(0, 5).forEach((error, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                
                const errorText = error.context.text.substring(
                    error.context.offset,
                    error.context.offset + error.context.length
                );
                
                const replacement = error.replacements[0]?.value || '';
                
                item.innerHTML = `
                    <div class="suggestion-text">
                        <strong>${errorText}</strong> â†’ ${replacement}
                        <br><small>${error.message}</small>
                    </div>
                    <button class="suggestion-replace" data-index="${index}">ØªØ·Ø¨ÙŠÙ‚</button>
                `;
                
                grammarSuggestions.appendChild(item);
            });

            grammarSuggestions.classList.add('visible');

            // Handle replace buttons
            document.querySelectorAll('.suggestion-replace').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const error = currentGrammarErrors[index];
                    const replacement = error.replacements[0]?.value || '';
                    
                    const text = textarea.value;
                    const before = text.substring(0, error.offset);
                    const after = text.substring(error.offset + error.length);
                    
                    textarea.value = before + replacement + after;
                    updateCounters();
                    
                    tg.HapticFeedback.impactOccurred('medium');
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØ­Øµ
                    grammarCheckBtn.click();
                });
            });
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function loadData() {
            if (!binId) {
                showError('Ù…Ø¹Ø±Ù ØºÙŠØ± ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·');
                return;
            }

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Master-Key': '$2a$10$LZzUrZstrWJsJROsgMvgeeoq0lC8lexDSW39z0hwNIxijF8y5jf7u'
                    }
                });

                if (!response.ok) {
                    throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
                }

                const data = await response.json();

                if (!data.record) {
                    throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }

                const record = data.record;

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ
                if (record.text) {
                    textarea.value = record.text;
                    textarea.defaultValue = record.text;
                    updateCounters();
                } else {
                    throw new Error('Ø§Ù„Ù†Øµ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }

                // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨
                requestIdEl.textContent = `ID: ${record.id || 'N/A'}`;

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª
                if (record.audioUrl) {
                    audioElement.src = record.audioUrl;
                    audioName.textContent = record.audioName || 'Ù…Ù„Ù ØµÙˆØªÙŠ';
                    
                    audioElement.addEventListener('loadedmetadata', () => {
                        audioLoaded = true;
                        const duration = audioElement.duration;
                        totalTimeEl.textContent = formatTime(duration);
                        audioMeta.textContent = `${formatTime(duration)} â€¢ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„`;
                        playBtn.disabled = false;
                        floatingPlayBtn.disabled = false;
                    });

                    audioElement.addEventListener('error', (e) => {
                        console.error('Audio load error:', e);
                        audioMeta.textContent = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª';
                        playBtn.disabled = true;
                        floatingPlayBtn.disabled = true;
                    });
                } else {
                    audioMeta.textContent = 'âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ØµÙˆØªÙŠ';
                    playBtn.disabled = true;
                    floatingPlayBtn.disabled = true;
                }

                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                loadingEl.classList.add('hidden');
                appEl.style.display = 'flex';
                
                setTimeout(() => {
                    textarea.focus();
                    textarea.setSelectionRange(0, 0);
                }, 300);

            } catch (error) {
                console.error('Load error:', error);
                showError(error.message);
            }
        }

        // Audio controls - Regular & Floating
        function togglePlayPause() {
            if (!audioLoaded) return;

            if (isPlaying) {
                audioElement.pause();
            } else {
                audioElement.play().catch(err => {
                    console.error('Play error:', err);
                    tg.showAlert('âš ï¸ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª');
                });
            }

            tg.HapticFeedback.impactOccurred('light');
        }

        playBtn.addEventListener('click', togglePlayPause);
        floatingPlayBtn.addEventListener('click', togglePlayPause);

        audioElement.addEventListener('timeupdate', () => {
            const progress = (audioElement.currentTime / audioElement.duration) * 100;
            progressFill.style.width = `${progress}%`;
            const time = formatTime(audioElement.currentTime);
            currentTimeEl.textContent = time;
            floatingTime.textContent = time;
        });

        audioElement.addEventListener('ended', () => {
            playBtn.textContent = 'â–¶ï¸';
            floatingPlayBtn.textContent = 'â–¶ï¸';
            playBtn.title = 'ØªØ´ØºÙŠÙ„';
            floatingPlayBtn.title = 'ØªØ´ØºÙŠÙ„';
            isPlaying = false;
            progressFill.style.width = '0%';
            audioElement.currentTime = 0;
        });

        audioElement.addEventListener('pause', () => {
            playBtn.textContent = 'â–¶ï¸';
            floatingPlayBtn.textContent = 'â–¶ï¸';
            playBtn.title = 'ØªØ´ØºÙŠÙ„';
            floatingPlayBtn.title = 'ØªØ´ØºÙŠÙ„';
            isPlaying = false;
        });

        audioElement.addEventListener('play', () => {
            playBtn.textContent = 'â¸';
            floatingPlayBtn.textContent = 'â¸';
            playBtn.title = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
            floatingPlayBtn.title = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
            isPlaying = true;
        });

        progressBar.addEventListener('click', (e) => {
            if (!audioLoaded) return;
            
            const rect = progressBar.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const percent = clickX / rect.width;
            
            audioElement.currentTime = percent * audioElement.duration;
            
            tg.HapticFeedback.impactOccurred('medium');
        });

        // Speed control - Regular & Floating
        function changeSpeed(speed) {
            audioElement.playbackRate = speed;
            
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.floating-speed-btn').forEach(b => b.classList.remove('active'));
            
            document.querySelectorAll(`[data-speed="${speed}"]`).forEach(b => b.classList.add('active'));
            
            tg.HapticFeedback.impactOccurred('light');
        }

        document.querySelectorAll('.speed-btn, .floating-speed-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const speed = parseFloat(btn.dataset.speed);
                changeSpeed(speed);
            });
        });

        // Text area events
        textarea.addEventListener('input', updateCounters);

        // Save corrected text
        async function saveCorrectedText(correctedText) {
            try {
                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': '$2a$10$LZzUrZstrWJsJROsgMvgeeoq0lC8lexDSW39z0hwNIxijF8y5jf7u'
                    },
                    body: JSON.stringify({
                        type: 'text_correction',
                        originalBinId: originalBinId,
                        text: correctedText,
                        charCount: correctedText.length,
                        wordCount: correctedText.trim().split(/\s+/).length,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØµØ­Ø­');
                }

                const data = await response.json();
                return data.metadata.id;

            } catch (error) {
                console.error('Save error:', error);
                throw error;
            }
        }

        // Main button
        tg.MainButton.setText('Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ âœ…');
        tg.MainButton.color = '#4A90E2';
        tg.MainButton.textColor = '#FFFFFF';
        tg.MainButton.show();

        tg.MainButton.onClick(async () => {
            const text = textarea.value.trim();
            
            if (!text) {
                tg.showAlert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Øµ');
                return;
            }

            if (text.length < 10) {
                tg.showAlert('âš ï¸ Ø§Ù„Ù†Øµ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£Ù‚Ù„ Ù…Ù† 10 Ø£Ø­Ø±Ù)');
                return;
            }

            tg.MainButton.showProgress();
            tg.MainButton.disable();

            try {
                const correctedBinId = await saveCorrectedText(text);

                const dataToSend = {
                    type: 'text_correction',
                    correctedBinId: correctedBinId,
                    originalBinId: originalBinId,
                    timestamp: new Date().toISOString()
                };

                console.log('ğŸ“¤ Sending to Telegram:', dataToSend);

                tg.sendData(JSON.stringify(dataToSend));
                
                setTimeout(() => {
                    try {
                        localStorage.removeItem(`draft_${binId}`);
                    } catch (e) {}
                    
                    tg.showAlert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ Ø¨Ù†Ø¬Ø§Ø­!', () => {
                        tg.close();
                    });
                }, 100);
                
            } catch (error) {
                console.error('Send error:', error);
                tg.MainButton.hideProgress();
                tg.MainButton.enable();
                tg.showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        });

        // Back button
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            const originalText = textarea.defaultValue || '';
            const currentText = textarea.value;
            
            if (originalText !== currentText && currentText.trim()) {
                tg.showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§ØªØŸ', (confirmed) => {
                    if (confirmed) {
                        tg.close();
                    }
                });
            } else {
                tg.close();
            }
        });

        // Auto-save draft
        let autoSaveTimer;
        textarea.addEventListener('input', () => {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                try {
                    localStorage.setItem(`draft_${binId}`, textarea.value);
                } catch (e) {}
            }, 10000);
        });

        // Load draft
        window.addEventListener('load', () => {
            try {
                const draft = localStorage.getItem(`draft_${binId}`);
                if (draft && draft !== textarea.value && draft.trim()) {
                    tg.showConfirm('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ØŸ', (confirmed) => {
                        if (confirmed) {
                            textarea.value = draft;
                            updateCounters();
                        }
                    });
                }
            } catch (e) {}
        });

        // Initialize
        detectKeyboard();
        loadData();

        console.log('ğŸš€ Text Editor App v4.0 - Keyboard Optimized');
        console.log('ğŸ“± Telegram WebApp SDK:', tg.version);
        console.log('ğŸ†” Bin ID:', binId);
    </script>
</body>
</html>
