<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ØªØµØ­ÙŠØ­ Ø§Ù„Ù†Øµ - Ù…ÙˆÙ‚Ø¹ Ø±Ù‚ÙŠØªÙŠ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
        }

        .header {
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            padding: 12px 16px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            flex-shrink: 0;
        }

        h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--tg-theme-text-color, #000);
        }

        .subtitle {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #fff);
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            overflow: hidden;
        }

        .info-card {
            background: linear-gradient(135deg, var(--tg-theme-button-color, #0088cc) 0%, var(--tg-theme-button-color, #006699) 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 14px;
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .textarea-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 12px;
            overflow: hidden;
            background: var(--tg-theme-bg-color, #fff);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        textarea {
            flex: 1;
            width: 100%;
            padding: 16px;
            border: none;
            font-size: 16px;
            line-height: 1.6;
            resize: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: transparent;
            color: var(--tg-theme-text-color, #000);
            outline: none;
        }

        textarea::placeholder {
            color: var(--tg-theme-hint-color, #999);
        }

        .footer {
            padding: 12px 16px;
            background: var(--tg-theme-secondary-bg-color, #f7f7f7);
            border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--tg-theme-hint-color, #666);
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            font-weight: 600;
            color: var(--tg-theme-text-color, #000);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--tg-theme-bg-color, #fff);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 1000;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--tg-theme-hint-color, #e0e0e0);
            border-top-color: var(--tg-theme-button-color, #0088cc);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--tg-theme-hint-color, #999);
            font-size: 14px;
        }

        .error {
            background: #ff3b30;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 16px;
            text-align: center;
            display: none;
        }

        .error.show {
            display: block;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .info-card {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <div id="error" class="error"></div>

    <div id="app" style="display: none; height: 100%; display: flex; flex-direction: column;">
        <div class="header">
            <h1>âœï¸ ØªØµØ­ÙŠØ­ Ø§Ù„Ù†Øµ</h1>
            <div class="subtitle">
                <span class="status">ğŸŸ¢ Ù…ØªØµÙ„</span>
                <span id="requestId"></span>
            </div>
        </div>

        <div class="content fade-in">
            <div class="info-card">
                ğŸ“ Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ Ø£Ø¯Ù†Ø§Ù‡ ÙƒÙ…Ø§ ØªØ±ÙŠØ¯ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø²Ø± "Ø¥Ø±Ø³Ø§Ù„" ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
            </div>

            <div class="textarea-container">
                <textarea 
                    id="textArea" 
                    placeholder="Ø§Ù„Ù†Øµ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§..."
                    spellcheck="true"
                    autocomplete="off"
                    autocorrect="on"
                ></textarea>
            </div>
        </div>

        <div class="footer">
            <div class="stats">
                <div class="stat">
                    <span>ğŸ“Š</span>
                    <span class="stat-value" id="charCount">0</span>
                    <span>Ø­Ø±Ù</span>
                </div>
                <div class="stat">
                    <span>ğŸ“</span>
                    <span class="stat-value" id="wordCount">0</span>
                    <span>ÙƒÙ„Ù…Ø©</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        
        // Expand to full height
        tg.expand();
        
        // Enable closing confirmation
        tg.enableClosingConfirmation();

        // Set header color
        tg.setHeaderColor('secondary_bg_color');

        // Elements
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const appEl = document.getElementById('app');
        const textarea = document.getElementById('textArea');
        const charCount = document.getElementById('charCount');
        const wordCount = document.getElementById('wordCount');
        const requestIdEl = document.getElementById('requestId');

        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const encodedText = urlParams.get('text');
        const requestId = urlParams.get('id') || 'Unknown';

        // Show error function
        function showError(message) {
            errorEl.textContent = message;
            errorEl.classList.add('show');
            loadingEl.classList.add('hidden');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }

        // Update counters
        function updateCounters() {
            const text = textarea.value;
            const chars = text.length;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            
            charCount.textContent = chars.toLocaleString('ar-EG');
            wordCount.textContent = words.toLocaleString('ar-EG');
            
            // Update button text with stats
            tg.MainButton.setText(`Ø¥Ø±Ø³Ø§Ù„ (${chars} Ø­Ø±Ù)`);
        }

        // Load text
        try {
            if (!encodedText) {
                throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
            }

            const decodedText = decodeURIComponent(encodedText);
            
            if (!decodedText || decodedText.length < 3) {
                throw new Error('Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø³Ù„ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ Ø£Ùˆ ÙØ§Ø±Øº');
            }

            textarea.value = decodedText;
            requestIdEl.textContent = `ID: ${requestId}`;
            updateCounters();
            
            // Show app
            loadingEl.classList.add('hidden');
            appEl.style.display = 'flex';
            
            // Focus textarea after a short delay
            setTimeout(() => {
                textarea.focus();
            }, 300);
            
        } catch (error) {
            showError(error.message);
            console.error('Load error:', error);
        }

        // Listen to textarea changes
        textarea.addEventListener('input', updateCounters);

        // Setup Main Button
        tg.MainButton.setText('Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ âœ…');
        tg.MainButton.color = tg.themeParams.button_color || '#0088cc';
        tg.MainButton.textColor = tg.themeParams.button_text_color || '#ffffff';
        tg.MainButton.show();

        // Main Button click handler
        tg.MainButton.onClick(function() {
            const correctedText = textarea.value.trim();
            
            if (!correctedText) {
                tg.showAlert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Øµ');
                return;
            }

            if (correctedText.length < 10) {
                tg.showAlert('âš ï¸ Ø§Ù„Ù†Øµ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£Ù‚Ù„ Ù…Ù† 10 Ø£Ø­Ø±Ù)');
                return;
            }

            // Show progress
            tg.MainButton.showProgress();
            tg.MainButton.disable();

            // Prepare data
            const data = {
                type: 'text_correction',
                id: requestId,
                text: correctedText,
                charCount: correctedText.length,
                wordCount: correctedText.trim().split(/\s+/).length,
                timestamp: new Date().toISOString()
            };

            // Send data to bot
            try {
                tg.sendData(JSON.stringify(data));
                
                // Success feedback
                tg.showAlert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ Ø¨Ù†Ø¬Ø§Ø­!', function() {
                    tg.close();
                });
            } catch (error) {
                tg.MainButton.hideProgress();
                tg.MainButton.enable();
                tg.showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + error.message);
            }
        });

        // Back Button
        tg.BackButton.show();
        tg.BackButton.onClick(function() {
            const originalText = decodeURIComponent(encodedText || '');
            const currentText = textarea.value;
            
            if (originalText !== currentText) {
                tg.showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§ØªØŸ', function(confirmed) {
                    if (confirmed) {
                        tg.close();
                    }
                });
            } else {
                tg.close();
            }
        });

        // Keyboard shortcuts
        textarea.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to send
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                tg.MainButton.click();
            }
            
            // Ctrl/Cmd + S to save (prevent default)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                tg.MainButton.click();
            }
        });

        // Haptic feedback on focus
        textarea.addEventListener('focus', function() {
            tg.HapticFeedback.impactOccurred('light');
        });

        // Auto-save to localStorage every 5 seconds
        let autoSaveTimer;
        textarea.addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                try {
                    localStorage.setItem('draft_' + requestId, textarea.value);
                    console.log('Auto-saved draft');
                } catch (e) {
                    console.warn('Could not auto-save:', e);
                }
            }, 5000);
        });

        // Load draft on start
        try {
            const draft = localStorage.getItem('draft_' + requestId);
            if (draft && draft !== textarea.value) {
                tg.showConfirm('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ØŸ', function(confirmed) {
                    if (confirmed) {
                        textarea.value = draft;
                        updateCounters();
                    }
                });
            }
        } catch (e) {
            console.warn('Could not load draft:', e);
        }

        // Clear draft after successful send
        window.addEventListener('beforeunload', function() {
            try {
                localStorage.removeItem('draft_' + requestId);
            } catch (e) {
                console.warn('Could not clear draft:', e);
            }
        });

        // Log ready state
        console.log('Telegram Web App initialized');
        console.log('User data:', tg.initDataUnsafe);
        console.log('Request ID:', requestId);
    </script>
</body>
</html>
