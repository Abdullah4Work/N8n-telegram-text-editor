name: Deploy to GitHub Pages with Secrets

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ðŸ”§ Create config.js from Secrets
        run: |
          cat > config.js << 'EOF'
          // ==============================================
          // ðŸ” Auto-generated Configuration from GitHub Secrets
          // âš ï¸ Do not edit manually - Generated by GitHub Actions
          // ==============================================
          
          const CONFIG = {
              // AssemblyAI API Configuration
              ASSEMBLYAI: {
                  API_KEY: '${{ secrets.ASSEMBLYAI_API_KEY }}',
                  UPLOAD_URL: '${{ secrets.ASSEMBLYAI_UPLOAD_URL }}',
                  TRANSCRIPT_URL: '${{ secrets.ASSEMBLYAI_TRANSCRIPT_URL }}',
                  LANGUAGE_CODE: 'ar',
                  SETTINGS: {
                      speaker_labels: true,
                      punctuate: true,
                      format_text: true,
                      language_code: 'ar',
                      disfluencies: false,
                      auto_chapters: false
                  }
              },

              // JSONBin API Configuration
              JSONBIN: {
                  API_KEY: '${{ secrets.JSONBIN_API_KEY }}',
                  BASE_URL: '${{ secrets.JSONBIN_BASE_URL }}'
              },

              // Web App Configuration
              APP: {
                  WEB_APP_URL: '${{ secrets.WEB_APP_URL }}',
                  MAX_FILE_SIZE: 52428800, // 50 MB in bytes
                  ALLOWED_AUDIO_FORMATS: [
                      'audio/mpeg',
                      'audio/wav',
                      'audio/ogg',
                      'audio/m4a',
                      'audio/flac',
                      'audio/mp3',
                      'audio/webm'
                  ],
                  MAX_TEXT_LENGTH: 100000,
                  AUTO_SAVE_INTERVAL: 30000, // 30 seconds
                  MIN_TEXT_LENGTH: 10
              },

              // Telegram Configuration
              TELEGRAM: {
                  USER_ID: '${{ secrets.TELEGRAM_USER_ID }}'
              },

              // Database Configuration
              DATABASE: {
                  HOST: '${{ secrets.DB_HOST }}',
                  NAME: '${{ secrets.DB_NAME }}',
                  USER: '${{ secrets.DB_USER }}',
                  PASSWORD: '${{ secrets.DB_PASSWORD }}',
                  PORT: 3306
              },

              // Templates Configuration
              TEMPLATES: {
                  COUNT: 4,
                  COLORS_PER_TEMPLATE: 4,
                  TOTAL_IMAGES: 16,
                  BASE_PATH: './assets/templates/'
              },

              // Series Colors Palette
              SERIES_COLORS: [
                  { name: 'Ø£Ø²Ø±Ù‚ Ø¨Ù†ÙØ³Ø¬ÙŠ', value: '#667eea' },
                  { name: 'Ø£Ø­Ù…Ø± ÙˆØ±Ø¯ÙŠ', value: '#f5576c' },
                  { name: 'Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­', value: '#4facfe' },
                  { name: 'Ø£Ø®Ø¶Ø±', value: '#43e97b' },
                  { name: 'ÙˆØ±Ø¯ÙŠ', value: '#fa709a' },
                  { name: 'Ø£ØµÙØ±', value: '#feca57' },
                  { name: 'Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ', value: '#ff6348' },
                  { name: 'Ø±Ù…Ø§Ø¯ÙŠ Ø¯Ø§ÙƒÙ†', value: '#2c3e50' }
              ],

              // API Rate Limits
              RATE_LIMITS: {
                  ASSEMBLYAI_MAX_FILE_SIZE: 52428800, // 50 MB
                  ASSEMBLYAI_MAX_DURATION: 7200, // 2 hours in seconds
                  MAX_REQUESTS_PER_MINUTE: 30
              },

              // Feature Flags
              FEATURES: {
                  ENABLE_AUTO_SAVE: true,
                  ENABLE_GRAMMAR_CHECK: true,
                  ENABLE_VOICE_PREVIEW: true,
                  ENABLE_TEMPLATE_PREVIEW: true
              }
          };

          // Export for use in other files
          if (typeof module !== 'undefined' && module.exports) {
              module.exports = CONFIG;
          }

          // Freeze config to prevent modifications
          if (typeof Object.freeze === 'function') {
              Object.freeze(CONFIG);
          }

          console.log('âœ… Configuration loaded successfully');
          EOF

      - name: ðŸ“ Verify config.js was created
        run: |
          echo "ðŸ“„ Checking config.js..."
          if [ -f config.js ]; then
            echo "âœ… config.js exists"
            echo "ðŸ“Š File size: $(wc -c < config.js) bytes"
            echo "ðŸ“‹ First 5 lines:"
            head -n 5 config.js
          else
            echo "âŒ config.js not found!"
            exit 1
          fi

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ðŸš€ Deploy from ${{ github.sha }}'

      - name: âœ… Deployment Complete
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸŒ Site URL: https://abdullah4work.github.io/N8n-telegram-text-editor/"
          echo "ðŸ“… Deployed at: $(date)"
